<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>XeonDB - Manage Database</title>
  <meta name="description" content="Manage your XeonDB database." />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet" />

  <link rel="icon" href="/logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/css/manage.css" />
</head>

<body>
  <%- include('alert.ejs') %>
    <input type="radio" name="nav" id="tab-overview" class="nav-toggle" checked />
    <input type="radio" name="nav" id="tab-data" class="nav-toggle" />
    <input type="radio" name="nav" id="tab-users" class="nav-toggle" />
    <input type="radio" name="nav" id="tab-whitelist" class="nav-toggle" disabled />
    <input type="radio" name="nav" id="tab-backups" class="nav-toggle" disabled />
    <input type="radio" name="nav" id="tab-billing" class="nav-toggle" />

    <div class="page-container">
      <div class="content-wrapper">
        <div class="manage-shell">
          <div class="topbar">
            <a class="brand" href="/" aria-label="Back to XeonDB home">
              <img src="/logo.png" alt="XeonDB logo" />
              <span>XeonDB</span>
            </a>
            <div class="topbar-right">
              <a class="btn" href="/dashboard">Dashboard</a>
              <div class="user-avatar">
                <%= name %>
              </div>
            </div>
          </div>

          <div class="db-header">
            <h1 class="db-title">Instance: <%= (instance && (instance.name || instance.id)) ? (instance.name ||
                instance.id) : 'Database' %>
            </h1>
            <% const st=(instance && instance.status ? String(instance.status) : 'online' ).toLowerCase(); %>
              <span class="db-status <%= st === 'online' ? 'online' : 'offline' %>">
                <span class="db-status-dot"></span>
                <%= st==='online' ? 'Online' : 'Offline' %>
              </span>
          </div>

          <div class="shell-grid">
            <aside class="sidebar">
              <div class="sidebar-header">
                <img src="/logo.png" alt="XeonDB logo" />
                <span>Cloud DB: <%= (instance && (instance.name || instance.id)) ? (instance.name || instance.id)
                    : 'DB Cloud Portal' %></span>
              </div>
              <nav class="sidebar-nav">
                <label for="tab-overview" class="nav-item">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                  </svg>
                  Overview
                </label>
                <label for="tab-data" class="nav-item">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="16 18 22 12 16 6"></polyline>
                    <polyline points="8 6 2 12 8 18"></polyline>
                  </svg>
                  Manage Data
                </label>
                <label for="tab-users" class="nav-item">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg>
                  Users
                </label>
                <label for="tab-whitelist" class="nav-item is-disabled" aria-disabled="true" title="Coming soon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  Whitelist
                </label>
                <label for="tab-backups" class="nav-item is-disabled" aria-disabled="true" title="Coming soon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  Backups
                </label>
                <label for="tab-billing" class="nav-item">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                  </svg>
                  Billing
                </label>

                <button class="nav-item nav-danger open-delete-modal" type="button">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                  </svg>
                  Delete Database
                </button>
              </nav>
            </aside>

            <div class="shell-main">
              <div class="overview-section">
                <div id="quota-warning" class="quota-warning" hidden role="status" aria-live="polite">
                  <div class="quota-warning-title" id="quota-warning-title"></div>
                  <div class="quota-warning-text" id="quota-warning-text"></div>
                </div>
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-header">
                    <span class="stat-title">Connections</span>
                  </div>
                <div class="stat-value" id="stat-connections">-- <span>active</span></div>
                <div class="chart-container">
                  <canvas id="connectionsChart"></canvas>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-header">
                  <span class="stat-title">Queries</span>
                </div>
                <div class="stat-value" id="stat-queries">-- <span>/day</span></div>
                <div class="chart-container">
                  <canvas id="queriesChart"></canvas>
                </div>
              </div>
            </div>

            <div class="quick-connect">
              <div class="qc-title">Quick Connect</div>
              <div class="qc-row">
                <div class="qc-col">
                  <div class="qc-field">
                    <span class="qc-label">Host</span>
                    <div class="qc-input-group">
                      <input id="qc-host" type="text" class="qc-input"
                        value="<%= instance && instance.host ? instance.host : '' %>" readonly />
                      <button class="qc-copy-btn" type="button" data-copy="qc-host" aria-label="Copy host">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                      </button>
                    </div>
                  </div>

                  <div class="qc-field">
                    <span class="qc-label">Port</span>
                    <div class="qc-input-group">
                      <input id="qc-port" type="text" class="qc-input"
                        value="<%= instance && instance.port ? instance.port : '' %>" readonly />
                      <button class="qc-copy-btn" type="button" data-copy="qc-port" aria-label="Copy port">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                      </button>
                    </div>
                  </div>

                  <% if (instance && instance.keyspace) { %>
                    <div class="qc-field">
                      <span class="qc-label">Keyspace</span>
                      <div class="qc-input-group">
                        <input id="qc-keyspace" type="text" class="qc-input" value="<%= instance.keyspace %>"
                          readonly />
                        <button class="qc-copy-btn" type="button" data-copy="qc-keyspace" aria-label="Copy keyspace">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                          </svg>
                        </button>
                      </div>
                    </div>
                    <% } %>
                </div>

                <div class="qc-col">
                  <div class="qc-field">
                    <span class="qc-label">Username</span>
                    <div class="qc-input-group">
                      <input id="qc-username" type="text" class="qc-input"
                        value="<%= instance && instance.db_username ? instance.db_username : '' %>" readonly />
                      <button class="qc-copy-btn" type="button" data-copy="qc-username" aria-label="Copy username">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                      </button>
                    </div>
                  </div>

                  <div class="qc-field">
                    <span class="qc-label">Password</span>
                    <div class="qc-input-group">
                      <input id="qc-password" type="password" class="qc-input" value="**************" readonly />
                      <button class="qc-copy-btn" id="qc-reveal" type="button" aria-label="Reveal password"
                        title="Reveal password" style="border-radius: 0; border-left: 1px solid var(--stroke);">
                        Reveal
                      </button>
                      <button class="qc-copy-btn" type="button" data-copy-secret="password" aria-label="Copy password">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                      </button>
                    </div>
                  </div>

                  <div class="qc-field">
                    <span class="qc-label"></span>
                    <div class="qc-input-group">
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

              <div class="main-panel">
            <div class="panel panel-data">
              <div class="panel-header">
                <h2 class="panel-title">Query Editor</h2>
              </div>
              <div class="query-editor">
                <% if (!(instance && instance.keyspace)) { %>
                  <input id="keyspace" class="add-user-input" placeholder="Keyspace (e.g. myapp)"
                    style="margin-bottom: 10px;" />
                  <% } %>
                    <textarea id="query" class="query-textarea"
                      placeholder="SELECT * FROM users WHERE id = 1;"></textarea>
                    <div class="query-actions">
                      <button class="query-btn" id="run-query" type="button">Run Query</button>
                    </div>
              </div>
              <div class="results-table-wrap">
                <table class="results-table">
                  <thead id="results-head"></thead>
                  <tbody id="results-body"></tbody>
                </table>
              </div>
            </div>

            <div class="panel panel-users">
              <div class="panel-header">
                <h2 class="panel-title">Database Users</h2>
              </div>
              <div class="user-list" id="db-users-list"></div>
              <div class="add-user-form" id="db-users-form">
                <input id="db-new-username" type="text" class="add-user-input" placeholder="New username..." autocomplete="off" />
                <input id="db-new-password" type="text" class="add-user-input" placeholder="Password (optional)" autocomplete="off" />
                <button class="add-user-btn" id="db-add-user" type="button">Add User</button>
              </div>
            </div>

            <div class="panel panel-whitelist">
              <div class="panel-header">
                <h2 class="panel-title">IP Whitelist</h2>
              </div>
              <div class="whitelist-info">
                <strong>Security Notice:</strong> Only whitelisted IPs can connect. 0.0.0.0/0 allows all.
              </div>
              <div id="whitelist-list" class="whitelist-list"></div>
              <div class="add-ip-form">
                <input id="add-ip-input" type="text" class="add-ip-input" placeholder="e.g. 203.0.113.50/32" />
                <button id="add-ip-btn" class="add-ip-btn" type="button">Add IP</button>
              </div>
            </div>

            <div class="panel panel-backups">
              <div class="panel-header">
                <h2 class="panel-title">Database Backups</h2>
                <button class="query-btn" id="create-backup" type="button">Create Backup</button>
              </div>
              <div id="backup-list" class="backup-list"></div>
            </div>

            <div class="panel panel-billing">
              <div class="panel-header">
                <h2 class="panel-title">Billing & Plan</h2>
              </div>
              <div class="billing-current">
                <div class="current-plan">
                  <div class="plan-info">
                    <% const plan=(instance && instance.plan ? String(instance.plan) : 'free' ).toLowerCase(); %>
                      <span class="plan-name">
                        <%= plan==='pro' ? 'Pro Plan' : 'Free Plan' %>
                      </span>
                      <span class="plan-price">
                        <%= plan==='pro' ? '$15/month' : '$0/month' %>
                      </span>
                  </div>
                  <span class="plan-badge <%= plan === 'pro' ? 'pro' : 'free' %>">Active</span>
                </div>
              </div>
              <div class="usage-section">
                <h3 class="usage-title">Current Usage</h3>
                <div class="usage-bar">
                  <div class="usage-fill" id="usage-fill" style="width: 0%;"></div>
                </div>
                <div class="usage-labels">
                  <span id="usage-used">-- used</span>
                  <span id="usage-total">-- total</span>
                </div>
              </div>
              <div class="upgrade-section">
                <h3 class="usage-title">Upgrade to Pro</h3>
                <div class="plan-option disabled">
                  <div class="plan-header">
                    <span class="plan-name">Pro</span>
                    <span class="plan-price">$15<span>/month</span></span>
                  </div>
                  <div class="plan-features">
                    <div class="plan-feature">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                      </svg>
                      100 GB storage
                    </div>
                    <div class="plan-feature">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                      </svg>
                      Unlimited connections
                    </div>
                    <div class="plan-feature">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                      </svg>
                      Priority support
                    </div>
                  </div>
                  <span class="plan-badge coming">Coming Soon</span>
                </div>
              </div>

             <div class="danger-zone">
                <h3 class="usage-title">Danger Zone</h3>
                <button class="danger-btn open-delete-modal" type="button">Delete Database</button>
              </div>
            </div>
          </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="delete-backdrop" id="delete-backdrop" hidden>
      <div class="delete-modal" role="dialog" aria-modal="true" aria-labelledby="delete-title">
        <div class="delete-modal-header">
          <h2 class="delete-modal-title" id="delete-title">Delete Database</h2>
          <button class="delete-close" id="delete-cancel-x" type="button" aria-label="Close">Ã—</button>
        </div>

        <div class="delete-modal-body">
          <div class="delete-warning">
            This will delete this database forever. Please make sure you have a backup if you think you might need the
            data later.
          </div>

          <div class="delete-confirm-row">
            <div class="delete-confirm-label">Type this to confirm</div>
            <div class="confirm-token" id="delete-confirm-token" tabindex="-1" aria-hidden="true">
              <%= (instance && (instance.name || instance.id)) ? (instance.name || instance.id) : 'Database' %>
            </div>
          </div>

          <input class="delete-input" id="delete-input" type="text" autocomplete="off"
            placeholder="Enter database name" />

          <label class="delete-ack">
            <input id="delete-ack" type="checkbox" />
            <span>I understand this can't be undone</span>
          </label>
        </div>

        <div class="delete-modal-footer">
          <button class="btn" id="delete-cancel" type="button">Cancel</button>
          <button class="danger-btn" id="delete-confirm" type="button" disabled>Delete</button>
        </div>
      </div>
    </div>

    <script>
      Chart.defaults.color = 'rgba(233, 230, 218, 0.74)';
      Chart.defaults.borderColor = 'rgba(233, 230, 218, 0.08)';
      Chart.defaults.font.family = '"Space Grotesk", sans-serif';

      const connectionsCtxEl = document.getElementById('connectionsChart');
      const connectionsCtx = connectionsCtxEl ? connectionsCtxEl.getContext('2d') : null;
      const connectionsChart = connectionsCtx ? new Chart(connectionsCtx, {
        type: 'line',
        data: {
          labels: ['-24h', '-20h', '-16h', '-12h', '-8h', '-4h'],
          datasets: [{
            data: [0, 0, 0, 0, 0, 0],
            borderColor: '#39c6ff',
            backgroundColor: 'rgba(57, 198, 255, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#39c6ff',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(11, 16, 32, 0.95)',
              titleColor: '#e9e6da',
              bodyColor: '#39c6ff',
              bodyFont: { family: '"JetBrains Mono", monospace', weight: 600 },
              borderColor: 'rgba(57, 198, 255, 0.3)',
              borderWidth: 1,
              padding: 10,
              displayColors: false,
              callbacks: {
                label: function (context) {
                  return context.parsed.y + ' connections';
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 10 } }
            },
            y: {
              min: 0,
              grid: { color: 'rgba(233, 230, 218, 0.05)' },
              ticks: {
                font: { size: 10 },
                callback: function (value) {
                  return value;
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      }) : null;

      const queriesCtxEl = document.getElementById('queriesChart');
      const queriesCtx = queriesCtxEl ? queriesCtxEl.getContext('2d') : null;
      const queriesChart = queriesCtx ? new Chart(queriesCtx, {
        type: 'line',
        data: {
          labels: ['-24h', '-20h', '-16h', '-12h', '-8h', '-4h'],
          datasets: [{
            data: [0, 0, 0, 0, 0, 0],
            borderColor: '#2ed3a1',
            backgroundColor: 'rgba(46, 211, 161, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#2ed3a1',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(11, 16, 32, 0.95)',
              titleColor: '#e9e6da',
              bodyColor: '#2ed3a1',
              bodyFont: { family: '"JetBrains Mono", monospace', weight: 600 },
              borderColor: 'rgba(46, 211, 161, 0.3)',
              borderWidth: 1,
              padding: 10,
              displayColors: false,
              callbacks: {
                label: function (context) {
                  return context.parsed.y + ' queries';
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { font: { size: 10 } }
            },
            y: {
              min: 0,
              grid: { color: 'rgba(233, 230, 218, 0.05)' },
              ticks: {
                font: { size: 10 },
                callback: function (value) {
                  return value >= 1000 ? (value / 1000).toFixed(1) + 'k' : value;
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      }) : null;

      (function () {
        const instanceId = "<%= instance && instance.id ? String(instance.id) : '' %>";
        const instanceConfirmText = "<%= (instance && (instance.name || instance.id)) ? String(instance.name || instance.id) : 'Database' %>";
        const instanceKeyspace = "<%= instance && instance.keyspace ? String(instance.keyspace) : '' %>";
        const instancePlan = "<%= instance && instance.plan ? String(instance.plan) : 'free' %>";
        if (!instanceId) return;

        let cachedCreds = null;
        let passwordVisible = false;

        async function getCreds() {
          if (cachedCreds) return cachedCreds;
          const res = await fetch(`/api/instances/${instanceId}/credentials`, { credentials: 'same-origin' });
          const data = await res.json().catch(() => null);
          if (!res.ok || !data || data.ok !== true) {
            throw new Error((data && data.error) || 'Failed to load credentials');
          }
          cachedCreds = data.credentials;
          return cachedCreds;
        }

        async function copyText(text) {
          const s = String(text || '');
          if (!s) throw new Error('Nothing to copy');
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(s);
            return;
          }
          const ta = document.createElement('textarea');
          ta.value = s;
          ta.setAttribute('readonly', '');
          ta.style.position = 'fixed';
          ta.style.top = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }

        function toast(type, msg) {
          if (typeof window.showToast === 'function') {
            window.showToast(type, msg);
            return;
          }
          if (typeof window.createAlert === 'function') {
            window.createAlert(type, msg);
            return;
          }
          if (typeof alert === 'function') alert(msg);
        }

        const statConnectionsEl = document.getElementById('stat-connections');
        const statQueriesEl = document.getElementById('stat-queries');
        const usageFillEl = document.getElementById('usage-fill');
        const usageUsedEl = document.getElementById('usage-used');
        const usageTotalEl = document.getElementById('usage-total');
        const quotaWarnEl = document.getElementById('quota-warning');
        const quotaWarnTitleEl = document.getElementById('quota-warning-title');
        const quotaWarnTextEl = document.getElementById('quota-warning-text');

        const planLower = String(instancePlan || 'free').trim().toLowerCase();
        const quotaBytes = planLower === 'pro'
          ? (100 * 1024 * 1024 * 1024)
          : (500 * 1024 * 1024);

        function clamp(n, a, b) {
          const v = Number(n);
          if (!Number.isFinite(v)) return a;
          return Math.max(a, Math.min(b, v));
        }

        function formatBytesForQuota(bytes, total) {
          const b = Math.max(0, Number(bytes) || 0);
          const t = Math.max(0, Number(total) || 0);
          const useGb = t >= (1024 * 1024 * 1024);
          const unit = useGb ? 'GB' : 'MB';
          const div = useGb ? (1024 * 1024 * 1024) : (1024 * 1024);
          const val = b / div;
          const digits = useGb ? 2 : 1;
          const s = Number.isFinite(val) ? val.toFixed(digits) : '0';
          const tidy = s
            .replace(/\.0+$/, '')
            .replace(/(\.[0-9]*[1-9])0+$/, '$1');
          return tidy + ' ' + unit;
        }

        function updateUsage(metrics) {
          if (!usageFillEl || !usageUsedEl || !usageTotalEl) return;

          const used = metrics && Object.prototype.hasOwnProperty.call(metrics, 'bytes_used')
            ? Number(metrics.bytes_used)
            : NaN;
          const usedBytes = Number.isFinite(used) ? Math.max(0, used) : 0;
          const pct = quotaBytes > 0 ? (usedBytes / quotaBytes) * 100 : 0;
          usageFillEl.style.width = clamp(pct, 0, 100).toFixed(1) + '%';

          usageUsedEl.textContent = formatBytesForQuota(usedBytes, quotaBytes) + ' used';
          usageTotalEl.textContent = formatBytesForQuota(quotaBytes, quotaBytes) + ' total';
        }

        function updateQuotaWarning(metrics) {
          if (!quotaWarnEl || !quotaWarnTitleEl || !quotaWarnTextEl) return;

          const used = metrics && Object.prototype.hasOwnProperty.call(metrics, 'bytes_used')
            ? Number(metrics.bytes_used)
            : NaN;
          const usedBytes = Number.isFinite(used) ? Math.max(0, used) : 0;

          const serverQuota = metrics && Object.prototype.hasOwnProperty.call(metrics, 'quota_bytes')
            ? Number(metrics.quota_bytes)
            : NaN;
          const effectiveQuotaBytes = (Number.isFinite(serverQuota) && serverQuota > 0)
            ? serverQuota
            : quotaBytes;

          if (!(effectiveQuotaBytes > 0)) {
            quotaWarnEl.hidden = true;
            return;
          }

          const pct = usedBytes / effectiveQuotaBytes;
          const over = (metrics && metrics.over_quota === true) || usedBytes >= effectiveQuotaBytes;
          const near = pct >= 0.90;

          if (!over && !near) {
            quotaWarnEl.hidden = true;
            return;
          }

          quotaWarnEl.hidden = false;
          quotaWarnEl.classList.toggle('is-danger', over);
          quotaWarnEl.classList.toggle('is-warn', !over);

          if (over) {
            quotaWarnTitleEl.textContent = 'Storage quota exceeded';
            quotaWarnTextEl.textContent = 'Writes are disabled until you free space (TRUNCATE/DROP) or upgrade.';
            return;
          }

          quotaWarnTitleEl.textContent = 'Approaching storage quota';
          quotaWarnTextEl.textContent =
            `You are using ${Math.round(pct * 100)}% of your quota (` +
            `${formatBytesForQuota(usedBytes, effectiveQuotaBytes)} / ${formatBytesForQuota(effectiveQuotaBytes, effectiveQuotaBytes)}).`;
        }

        function formatCompact(n) {
          const v = Number(n);
          if (!Number.isFinite(v)) return String(n || '0');
          if (v >= 1e9) return (v / 1e9).toFixed(1).replace(/\.0$/, '') + 'b';
          if (v >= 1e6) return (v / 1e6).toFixed(1).replace(/\.0$/, '') + 'm';
          if (v >= 1e3) return (v / 1e3).toFixed(1).replace(/\.0$/, '') + 'k';
          return String(Math.round(v));
        }

        function updateStatsAndCharts(metrics) {
          if (!metrics || typeof metrics !== 'object') return;
          const active = Number(metrics.connections_active);
          const qTotal = Number(metrics.queries_last24h_total);

          if (statConnectionsEl) {
            statConnectionsEl.innerHTML = `${Number.isFinite(active) ? active : '--'} <span>active</span>`;
          }
          if (statQueriesEl) {
            statQueriesEl.innerHTML = `${Number.isFinite(qTotal) ? formatCompact(qTotal) : '--'} <span>/day</span>`;
          }

          const labels = Array.isArray(metrics.labels_last24h_4h) ? metrics.labels_last24h_4h : null;
          const conn = Array.isArray(metrics.connections_last24h_peak_4h) ? metrics.connections_last24h_peak_4h : null;
          const q4h = Array.isArray(metrics.queries_last24h_4h) ? metrics.queries_last24h_4h : null;

          if (connectionsChart && labels && conn && labels.length === 6 && conn.length === 6) {
            connectionsChart.data.labels = labels;
            connectionsChart.data.datasets[0].data = conn.map((x) => Number(x) || 0);
            connectionsChart.update('none');
          }

          if (queriesChart && labels && q4h && labels.length === 6 && q4h.length === 6) {
            queriesChart.data.labels = labels;
            queriesChart.data.datasets[0].data = q4h.map((x) => Number(x) || 0);
            queriesChart.update('none');
          }

          updateUsage(metrics);
          updateQuotaWarning(metrics);
        }

        async function refreshMetrics() {
          if (!instanceId) return;
          try {
            const data = await getJson(`/api/instances/${instanceId}/metrics`);
            updateStatsAndCharts(data.metrics);
          } catch {
            // ignore
          }
        }

        document.querySelectorAll('[data-copy]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-copy');
            const el = id ? document.getElementById(id) : null;
            try {
              await copyText(el ? el.value : '');
              toast('success', 'Copied');
            } catch (e) {
              toast('error', e && e.message ? e.message : 'Copy failed');
            }
          });
        });

        document.querySelectorAll('[data-copy-secret="password"]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            try {
              const creds = await getCreds();
              await copyText(creds.password);
              toast('success', 'Password copied');
            } catch (e) {
              toast('error', e && e.message ? e.message : 'Copy failed');
            }
          });
        });

        const revealBtn = document.getElementById('qc-reveal');
        const pwInput = document.getElementById('qc-password');
        if (revealBtn && pwInput) {
          revealBtn.addEventListener('click', async () => {
            try {
              if (!passwordVisible) {
                const creds = await getCreds();
                pwInput.value = creds.password;
                pwInput.type = 'text';
                revealBtn.textContent = 'Hide';
                passwordVisible = true;
              } else {
                pwInput.value = '**************';
                pwInput.type = 'password';
                revealBtn.textContent = 'Reveal';
                passwordVisible = false;
              }
            } catch (e) {
              toast('error', e && e.message ? e.message : 'Failed');
            }
          });
        }

        const keyspaceEl = document.getElementById('keyspace');
        const queryEl = document.getElementById('query');
        const runBtn = document.getElementById('run-query');
        const headEl = document.getElementById('results-head');
        const bodyEl = document.getElementById('results-body');

        const keyspaceStorageKey = 'xeondb:keyspace:' + instanceId;
        if (keyspaceEl && !instanceKeyspace) {
          keyspaceEl.value = localStorage.getItem(keyspaceStorageKey) || '';
          keyspaceEl.addEventListener('input', () => {
            try {
              localStorage.setItem(keyspaceStorageKey, keyspaceEl.value);
            } catch {
              // ignore
            }
          });
        }

        function clearResults() {
          if (headEl) headEl.innerHTML = '';
          if (bodyEl) bodyEl.innerHTML = '';
        }

        function renderTable(headers, rows) {
          clearResults();
          if (!headEl || !bodyEl) return;

          const trh = document.createElement('tr');
          headers.forEach((h) => {
            const th = document.createElement('th');
            th.textContent = h;
            trh.appendChild(th);
          });
          headEl.appendChild(trh);

          rows.forEach((row) => {
            const tr = document.createElement('tr');
            headers.forEach((h) => {
              const td = document.createElement('td');
              const v = row && Object.prototype.hasOwnProperty.call(row, h) ? row[h] : '';
              td.textContent = v === null || v === undefined ? '' : String(v);
              tr.appendChild(td);
            });
            bodyEl.appendChild(tr);
          });
        }

        function renderKeyValue(obj) {
          const entries = obj && typeof obj === 'object' ? Object.entries(obj) : [['result', obj]];
          const rows = entries.map(([k, v]) => ({ key: k, value: v === null || v === undefined ? '' : (typeof v === 'string' ? v : JSON.stringify(v)) }));
          renderTable(['key', 'value'], rows);
        }

        function renderResult(result) {
          if (!result || typeof result !== 'object') {
            renderKeyValue(result);
            return;
          }
          if (Array.isArray(result.rows)) {
            if (result.rows.length === 0) {
              clearResults();
              toast('info', 'No rows');
              return;
            }
            const headers = Object.keys(result.rows[0] || {});
            renderTable(headers, result.rows);
            return;
          }
          if (Object.prototype.hasOwnProperty.call(result, 'found')) {
            if (!result.found) {
              clearResults();
              toast('info', 'No rows');
              return;
            }
            const row = result.row || {};
            const headers = Object.keys(row);
            renderTable(headers, [row]);
            return;
          }
          renderKeyValue(result);
        }

        async function postJson(url, body) {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(body)
          });
          const data = await res.json().catch(() => null);
          if (!res.ok || !data) {
            throw new Error((data && (data.error || data.message)) || ('Request failed (' + res.status + ')'));
          }
          return data;
        }

        if (runBtn && queryEl) {
          runBtn.addEventListener('click', async () => {
            const keyspace = instanceKeyspace || (keyspaceEl ? String(keyspaceEl.value || '').trim() : '');
            const query = String(queryEl.value || '').trim();
            if (!query) {
              toast('warning', 'Enter a query');
              return;
            }
            runBtn.disabled = true;
            runBtn.textContent = 'Running...';
            try {
              const body = instanceKeyspace ? { query } : { keyspace, query };
              const data = await postJson(`/api/instances/${instanceId}/query`, body);
              renderResult(data.result);
              toast('success', 'Query executed');
            } catch (e) {
              toast('error', e && e.message ? e.message : 'Query failed');
            } finally {
              runBtn.disabled = false;
              runBtn.textContent = 'Run Query';
            }
          });
        }

        async function getJson(url) {
          const res = await fetch(url, { credentials: 'same-origin' });
          const data = await res.json().catch(() => null);
          if (!res.ok || !data) {
            throw new Error((data && (data.error || data.message)) || ('Request failed (' + res.status + ')'));
          }
          return data;
        }

        async function deleteJson(url) {
          const res = await fetch(url, { method: 'DELETE', credentials: 'same-origin' });
          const data = await res.json().catch(() => null);
          if (!res.ok || !data) {
            throw new Error((data && (data.error || data.message)) || ('Request failed (' + res.status + ')'));
          }
          return data;
        }

        const dbUsersListEl = document.getElementById('db-users-list');
        const addDbUserBtn = document.getElementById('db-add-user');
        const newDbUsernameEl = document.getElementById('db-new-username');
        const newDbPasswordEl = document.getElementById('db-new-password');

        function initials(s) {
          const t = String(s || '').trim();
          if (!t) return '--';
          const parts = t.split(/[^A-Za-z0-9]+/g).filter(Boolean);
          const a = (parts[0] && parts[0][0]) ? parts[0][0] : t[0];
          const b = (parts.length > 1 && parts[1][0]) ? parts[1][0] : (t.length > 1 ? t[1] : '');
          return (String(a) + String(b)).toUpperCase();
        }

        function renderDbUsers(list) {
          if (!dbUsersListEl) return;
          dbUsersListEl.innerHTML = '';

          const users = Array.isArray(list) ? list : [];
          if (users.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'user-item';
            empty.innerHTML = '<div class="user-info"><div class="user-avatar-sm">--</div><div><div class="user-name">No users</div><div class="user-role">Create one to grant access to this keyspace</div></div></div>';
            dbUsersListEl.appendChild(empty);
            return;
          }

          for (const u of users) {
            const username = String(u && u.username ? u.username : '');
            const access = String(u && u.access ? u.access : '').toLowerCase();
            const enabled = u && Object.prototype.hasOwnProperty.call(u, 'enabled') ? u.enabled : null;
            const isOwner = access === 'owner';

            const row = document.createElement('div');
            row.className = 'user-item';

            const info = document.createElement('div');
            info.className = 'user-info';
            info.innerHTML = '<div class="user-avatar-sm"></div><div><div class="user-name"></div><div class="user-role"></div></div>';
            info.querySelector('.user-avatar-sm').textContent = initials(username);
            info.querySelector('.user-name').textContent = username;

            let role = isOwner ? 'Owner' : 'Granted';
            if (enabled === false) role += ' (disabled)';
            info.querySelector('.user-role').textContent = role;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'user-remove-btn';
            btn.textContent = isOwner ? 'Owner' : 'Remove';
            if (isOwner) {
              btn.disabled = true;
              btn.style.opacity = '0.55';
              btn.style.cursor = 'not-allowed';
            } else {
              btn.addEventListener('click', async () => {
                try {
                  await deleteJson(`/api/instances/${instanceId}/db-users/${encodeURIComponent(username)}`);
                  toast('success', 'Removed');
                  await refreshDbUsers();
                } catch (e) {
                  toast('error', e && e.message ? e.message : 'Remove failed');
                }
              });
            }

            row.appendChild(info);
            row.appendChild(btn);
            dbUsersListEl.appendChild(row);
          }
        }

        async function refreshDbUsers() {
          if (!instanceId) return;
          if (!instanceKeyspace) {
            renderDbUsers([]);
            return;
          }
          try {
            const data = await getJson(`/api/instances/${instanceId}/db-users`);
            renderDbUsers(data.users);
          } catch (e) {
            toast('error', e && e.message ? e.message : 'Failed to load database users');
          }
        }

        if (addDbUserBtn) {
          addDbUserBtn.addEventListener('click', async () => {
            if (!instanceId) return;
            if (!instanceKeyspace) {
              toast('warning', 'No keyspace configured for this instance');
              return;
            }
            const username = newDbUsernameEl ? String(newDbUsernameEl.value || '').trim() : '';
            const password = newDbPasswordEl ? String(newDbPasswordEl.value || '').trim() : '';
            if (!username) {
              toast('warning', 'Enter a username');
              return;
            }

            addDbUserBtn.disabled = true;
            const prev = addDbUserBtn.textContent;
            addDbUserBtn.textContent = 'Adding...';
            try {
              const data = await postJson(`/api/instances/${instanceId}/db-users`, { username, password });
              const createdPassword = data && typeof data.password === 'string' ? data.password : '';
              if (newDbUsernameEl) newDbUsernameEl.value = '';
              if (newDbPasswordEl) newDbPasswordEl.value = '';
              await refreshDbUsers();
              if (createdPassword) {
                try {
                  await copyText(createdPassword);
                  toast('success', 'User created (password copied)');
                } catch {
                  toast('success', 'User created');
                }
              } else {
                toast('success', 'User created');
              }
            } catch (e) {
              toast('error', e && e.message ? e.message : 'Add failed');
            } finally {
              addDbUserBtn.disabled = false;
              addDbUserBtn.textContent = prev;
            }
          });
        }

        const wlListEl = document.getElementById('whitelist-list');
        const addIpInput = document.getElementById('add-ip-input');
        const addIpBtn = document.getElementById('add-ip-btn');

        function renderWhitelist(items, clientCidr) {
          if (!wlListEl) return;
          wlListEl.innerHTML = '';
          const list = Array.isArray(items) ? items.slice() : [];
          list.sort((a, b) => {
            const ac = String((a && a.cidr) || '');
            const bc = String((b && b.cidr) || '');
            if (ac === '0.0.0.0/0') return -1;
            if (bc === '0.0.0.0/0') return 1;
            return ac.localeCompare(bc);
          });

          for (const entry of list) {
            const cidr = String(entry && entry.cidr ? entry.cidr : '');
            const kind = String(entry && entry.kind ? entry.kind : 'custom').toLowerCase();
            const isDefault = kind === 'default' || cidr === '0.0.0.0/0';
            const isYourIp = !!clientCidr && cidr === clientCidr && !isDefault;

            const row = document.createElement('div');
            row.className = 'whitelist-item';

            const ipSpan = document.createElement('span');
            ipSpan.className = 'whitelist-ip';
            ipSpan.textContent = cidr;

            const badge = document.createElement('span');
            if (isDefault) {
              badge.className = 'whitelist-badge default';
              badge.textContent = 'Allow All';
            } else if (isYourIp) {
              badge.className = 'whitelist-badge auto';
              badge.textContent = 'Your IP';
            } else if (kind === 'auto') {
              badge.className = 'whitelist-badge auto';
              badge.textContent = 'Auto';
            } else {
              badge.className = 'whitelist-badge custom';
              badge.textContent = 'Custom';
            }

            const btn = document.createElement('button');
            btn.className = 'whitelist-remove-btn' + (isDefault ? ' disabled' : '');
            btn.type = 'button';
            btn.textContent = 'Remove';
            if (!isDefault) {
              btn.addEventListener('click', async () => {
                try {
                  await deleteJson(`/api/instances/${instanceId}/whitelist/${entry.id}`);
                  toast('success', 'Removed');
                  await refreshWhitelist();
                } catch (e) {
                  toast('error', e && e.message ? e.message : 'Remove failed');
                }
              });
            }

            row.appendChild(ipSpan);
            row.appendChild(badge);
            row.appendChild(btn);
            wlListEl.appendChild(row);
          }
        }

        async function refreshWhitelist() {
          try {
            const data = await getJson(`/api/instances/${instanceId}/whitelist`);
            renderWhitelist(data.whitelist, data.clientCidr);
          } catch (e) {
            toast('error', e && e.message ? e.message : 'Failed to load whitelist');
          }
        }

        if (addIpBtn && addIpInput) {
          addIpBtn.addEventListener('click', async () => {
            const cidr = String(addIpInput.value || '').trim();
            if (!cidr) {
              toast('warning', 'Enter an IP/CIDR');
              return;
            }
            addIpBtn.disabled = true;
            try {
              await postJson(`/api/instances/${instanceId}/whitelist`, { cidr });
              addIpInput.value = '';
              toast('success', 'Added');
              await refreshWhitelist();
            } catch (e) {
              toast('error', e && e.message ? e.message : 'Add failed');
            } finally {
              addIpBtn.disabled = false;
            }
          });
        }

        const backupListEl = document.getElementById('backup-list');
        const createBackupBtn = document.getElementById('create-backup');

        function renderBackups(items) {
          if (!backupListEl) return;
          backupListEl.innerHTML = '';
          const list = Array.isArray(items) ? items : [];
          if (list.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'backup-item';
            empty.innerHTML = '<div class="backup-info"><div class="backup-icon">-</div><div><div class="backup-name">No backups yet</div><div class="backup-date">Create one when you need it</div></div></div>';
            backupListEl.appendChild(empty);
            return;
          }

          for (const b of list) {
            const dir = String(b && b.dir ? b.dir : 'backup');
            const createdAt = b && b.created_at ? Number(b.created_at) : NaN;
            const dateStr = Number.isFinite(createdAt) ? new Date(createdAt).toLocaleString() : '';

            const row = document.createElement('div');
            row.className = 'backup-item';

            const info = document.createElement('div');
            info.className = 'backup-info';
            info.innerHTML =
              '<div class="backup-icon">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' +
              '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>' +
              '<polyline points="17 8 12 3 7 8"></polyline>' +
              '<line x1="12" y1="3" x2="12" y2="15"></line>' +
              '</svg>' +
              '</div>' +
              '<div><div class="backup-name"></div><div class="backup-date"></div></div>';
            info.querySelector('.backup-name').textContent = dir;
            info.querySelector('.backup-date').textContent = dateStr;

            const actions = document.createElement('div');
            actions.className = 'backup-actions';

            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'whitelist-remove-btn';
            del.textContent = 'Delete';
            del.addEventListener('click', async () => {
              try {
                await deleteJson(`/api/instances/${instanceId}/backups/${b.id}`);
                toast('success', 'Backup deleted');
                await refreshBackups();
              } catch (e) {
                toast('error', e && e.message ? e.message : 'Delete failed');
              }
            });

            actions.appendChild(del);
            row.appendChild(info);
            row.appendChild(actions);
            backupListEl.appendChild(row);
          }
        }

        async function refreshBackups() {
          try {
            const data = await getJson(`/api/instances/${instanceId}/backups`);
            renderBackups(data.backups);
          } catch (e) {
            toast('error', e && e.message ? e.message : 'Failed to load backups');
          }
        }

        if (createBackupBtn) {
          createBackupBtn.addEventListener('click', async () => {
            createBackupBtn.disabled = true;
            try {
              await postJson(`/api/instances/${instanceId}/backups`, {});
              toast('success', 'Backup created');
              await refreshBackups();
            } catch (e) {
              toast('error', e && e.message ? e.message : 'Create failed');
            } finally {
              createBackupBtn.disabled = false;
            }
          });
        }

        refreshWhitelist();
        refreshBackups();
        refreshDbUsers();
        refreshMetrics();
        setInterval(refreshMetrics, 60000);

        const deleteBackdrop = document.getElementById('delete-backdrop');
        const openDeleteBtns = document.querySelectorAll('.open-delete-modal');
        const deleteCancelBtn = document.getElementById('delete-cancel');
        const deleteCancelX = document.getElementById('delete-cancel-x');
        const deleteInput = document.getElementById('delete-input');
        const deleteAck = document.getElementById('delete-ack');
        const deleteConfirm = document.getElementById('delete-confirm');
        const deleteToken = document.getElementById('delete-confirm-token');

        function openDeleteModal() {
          if (!deleteBackdrop) return;
          deleteBackdrop.hidden = false;
          if (deleteInput) deleteInput.value = '';
          if (deleteAck) deleteAck.checked = false;
          if (deleteConfirm) deleteConfirm.disabled = true;
          setTimeout(() => {
            if (deleteInput) deleteInput.focus();
          }, 0);
        }

        function closeDeleteModal() {
          if (!deleteBackdrop) return;
          deleteBackdrop.hidden = true;
        }

        function updateDeleteEnabled() {
          if (!deleteConfirm || !deleteInput || !deleteAck) return;
          const typed = String(deleteInput.value || '').trim();
          const okText = typed === String(instanceConfirmText).trim();
          deleteConfirm.disabled = !(okText && deleteAck.checked);
        }

        if (deleteToken) {
          deleteToken.addEventListener('copy', (e) => e.preventDefault());
          deleteToken.addEventListener('cut', (e) => e.preventDefault());
          deleteToken.addEventListener('contextmenu', (e) => e.preventDefault());
          deleteToken.addEventListener('mousedown', (e) => {
            // prevent drag-select
            e.preventDefault();
          });
        }

        openDeleteBtns.forEach((b) => b.addEventListener('click', openDeleteModal));
        if (deleteCancelBtn) deleteCancelBtn.addEventListener('click', closeDeleteModal);
        if (deleteCancelX) deleteCancelX.addEventListener('click', closeDeleteModal);
        if (deleteBackdrop) {
          deleteBackdrop.addEventListener('click', (e) => {
            if (e.target === deleteBackdrop) closeDeleteModal();
          });
        }
        if (deleteInput) deleteInput.addEventListener('input', updateDeleteEnabled);
        if (deleteAck) deleteAck.addEventListener('change', updateDeleteEnabled);

        if (deleteConfirm) {
          deleteConfirm.addEventListener('click', async () => {
            deleteConfirm.disabled = true;
            try {
              const res = await fetch(`/api/instances/${instanceId}`, { method: 'DELETE', credentials: 'same-origin' });
              const data = await res.json().catch(() => null);
              if (!res.ok || !data || data.ok !== true) {
                throw new Error((data && (data.error || data.message)) || ('Delete failed (' + res.status + ')'));
              }
              toast('success', 'Database deleted');
              window.location.href = '/dashboard';
            } catch (e) {
              toast('error', e && e.message ? e.message : 'Delete failed');
              updateDeleteEnabled();
            }
          });
        }
      })();
    </script>
</body>

</html>
