<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>XeonDB - Dashboard</title>
  <meta name="description" content="Manage your XeonDB databases." />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet" />

  <link rel="icon" href="/logo.png" />
  <link rel="stylesheet" href="/css/dashbaord.css" />
</head>

<body>
  <input type="checkbox" id="modal-toggle" class="modal-toggle" />

  <div class="modal-backdrop">
    <div class="modal">
      <label for="modal-toggle" class="modal-close" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </label>

      <div class="modal-header">
        <h2 class="modal-title">Create a Database</h2>
        <p class="modal-subtitle">Choose a plan to get started</p>
      </div>

        <div class="modal-body">
        <label class="plan-option" data-plan="free">
          <div class="plan-header">
            <span class="plan-name">Free</span>
            <span class="plan-price">$0<span>/month</span></span>
          </div>
          <div class="plan-features">
            <div class="plan-feature">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              Sharded node architecture
            </div>
            <div class="plan-feature">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              500 MB storage
            </div>
            <div class="plan-feature">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              Community support
            </div>
          </div>
          <span class="plan-badge free">Available</span>
        </label>

        <div class="plan-option disabled" data-plan="pro">
          <div class="plan-header">
            <span class="plan-name">Pro</span>
            <span class="plan-price">$15<span>/month</span></span>
          </div>
          <div class="plan-features">
            <div class="plan-feature">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              Dedicated node
            </div>
            <div class="plan-feature">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              100 GB storage
            </div>
            <div class="plan-feature">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              Priority support
            </div>
          </div>
          <span class="plan-badge coming">Coming Soon</span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="modal-btn" id="create-db" type="button">Create Database</button>
      </div>
    </div>
  </div>

  <main class="dash-page">
    <div class="dash-shell">
      <div class="topbar">
        <a class="brand" href="/" aria-label="Back to XeonDB home">
          <img src="/logo.png" alt="XeonDB logo" />
          <span>XeonDB</span>
        </a>
        <div class="topbar-right">
          <a class="btn" href="/">Back to site</a>
          <a class="btn" href="/logout">Logout</a>
          <div class="user-avatar"><%= name %></div>
        </div>
      </div>

      <div class="page-header">
        <div>
          <h1 class="page-title">Your Databases</h1>
          <p class="page-subtitle">Manage and monitor your database clusters</p>
        </div>
      </div>

      <div class="dbs-grid">
        <% if (instances && instances.length) { %>
          <% instances.forEach(function(inst) { %>
            <div class="db-card">
              <div class="db-card-header">
                <div class="db-name"><%= inst.name || inst.id %></div>
                <% const st = (inst.status || 'online').toLowerCase(); %>
                <span class="db-status <%= st === 'online' ? 'online' : 'offline' %>">
                  <span class="db-status-dot"></span>
                  <%= st === 'online' ? 'Online' : 'Offline' %>
                </span>
              </div>
              <div class="db-info">
                <div class="db-info-row">
                  <span class="db-info-label">Plan</span>
                  <span class="db-info-value"><%= (inst.plan || 'free').toUpperCase() %></span>
                </div>
                <div class="db-info-row">
                  <span class="db-info-label">Host</span>
                  <span class="db-info-value"><%= inst.host %></span>
                </div>
                <div class="db-info-row">
                  <span class="db-info-label">Port</span>
                  <span class="db-info-value"><%= inst.port %></span>
                </div>
                <% if (inst.keyspace) { %>
                  <div class="db-info-row">
                    <span class="db-info-label">Keyspace</span>
                    <span class="db-info-value"><%= inst.keyspace %></span>
                  </div>
                <% } %>
                <div class="db-info-row">
                  <span class="db-info-label">Username</span>
                  <span class="db-info-value"><%= inst.db_username %></span>
                </div>
                <div class="db-info-row">
                  <span class="db-info-label">Password</span>
                  <span class="db-info-value">**************</span>
                </div>
              </div>
              <div class="db-actions">
                <button class="db-action-btn js-connect" type="button"
                  data-host="<%= inst.host %>"
                  data-port="<%= inst.port %>"
                  data-keyspace="<%= inst.keyspace ? inst.keyspace : '' %>"
                  data-username="<%= inst.db_username %>"
                  data-password="<%= inst.db_password %>">
                  Connect
                </button>
                <a class="db-action-btn" href="/dashboard/<%= inst.id %>" style="text-align:center; display:inline-block;">Manage</a>
              </div>
            </div>
          <% }); %>
        <% } %>

        <label for="modal-toggle" class="create-card">
          <div class="create-card-label">
            <div class="create-icon">+</div>
            <span class="create-text">Create Database</span>
            <span class="create-hint">Free plan available</span>
          </div>
        </label>
      </div>
    </div>
  </main>

  <script>
    (function () {
      function fmtConnect(host, port, keyspace, username, password) {
        var out = ['Host: ' + host, 'Port: ' + port];
        if (keyspace) out.push('Keyspace: ' + keyspace);
        out.push('Username: ' + username);
        out.push('Password: ' + password);
        return out.join('\n');
      }

      async function postJson(url, body) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        });
        let data = null;
        try { data = await res.json(); } catch { data = null; }
        if (!res.ok) {
          const err = data && (data.error || data.message) ? (data.error || data.message) : ('Request failed (' + res.status + ')');
          throw new Error(err);
        }
        return data;
      }

      document.querySelectorAll('.js-connect').forEach(function (btn) {
        btn.addEventListener('click', async function () {
          const host = btn.getAttribute('data-host') || '';
          const port = btn.getAttribute('data-port') || '';
          const keyspace = btn.getAttribute('data-keyspace') || '';
          const username = btn.getAttribute('data-username') || '';
          const password = btn.getAttribute('data-password') || '';
          const text = fmtConnect(host, port, keyspace, username, password);
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
              alert('Connection details copied to clipboard.\n\n' + text);
              return;
            }
          } catch {
            // fallthrough
          }
          alert(text);
        });
      });

      var createBtn = document.getElementById('create-db');
      var modalToggle = document.getElementById('modal-toggle');
      var selectedPlan = 'free';

      function setSelectedPlan(plan) {
        selectedPlan = plan === 'pro' ? 'pro' : 'free';
      }

      document.querySelectorAll('.plan-option[data-plan]').forEach(function (el) {
        el.addEventListener('click', function () {
          if (el.classList.contains('disabled')) return;
          setSelectedPlan(el.getAttribute('data-plan'));
        });
      });

      async function create(plan) {
        const data = await postJson('/api/instances', { plan: plan });
        if (modalToggle) modalToggle.checked = false;
        window.location.reload();
      }

      if (createBtn) {
        createBtn.addEventListener('click', function () {
          create(selectedPlan).catch(function (err) {
            alert(err && err.message ? err.message : String(err));
          });
        });
      }
    })();
  </script>
</body>

</html>
